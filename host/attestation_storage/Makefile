include ../../scripts/common.mk
out-dir := $(call strip-trailing-slashes-and-dots,$(O))
ifeq ($(out-dir),)
$(error invalid output directory (O=$(O)))
endif

include $(TA_DEV_KIT_DIR)/host_include/conf.mk

# By default we expect optee_client exported folder to be on a certain relative
# path, but if the client specifies the OPTEE_CLIENT_EXPORT then that path will
# be used instead.
OPTEE_CLIENT_EXPORT ?= ../../../optee_client/out/export

CC		?= $(CROSS_COMPILE)gcc
CPP		?= $(CROSS_COMPILE)cpp
LD		?= $(CROSS_COMPILE)ld
AR		?= $(CROSS_COMPILE)ar
NM		?= $(CROSS_COMPILE)nm
OBJCOPY		?= $(CROSS_COMPILE)objcopy
OBJDUMP		?= $(CROSS_COMPILE)objdump
READELF		?= $(CROSS_COMPILE)readelf

srcs := attestation_storage.c

OBJS  := $(patsubst %.c,$(out-dir)/xtest/%.o, $(srcs))

CFLAGS += -I../xtest/
CFLAGS += -I../xtest/adbg/include
CFLAGS += -I../xtest/xml/include
CFLAGS += -I$(out-dir)/xtest

# CFLAGS += -I$(out-dir)/attestation-storage

CFLAGS += -I$(OPTEE_CLIENT_EXPORT)/include
CFLAGS += -I$(TA_DEV_KIT_DIR)/host_include

CFLAGS += -I../../ta/include
CFLAGS += -I../../ta/create_fail_test/include
CFLAGS += -I../../ta/crypt/include
CFLAGS += -I../../ta/enc_fs/include
CFLAGS += -I../../ta/os_test/include
CFLAGS += -I../../ta/rpc_test/include
CFLAGS += -I../../ta/sims/include
CFLAGS += -I../../ta/storage_benchmark/include
CFLAGS += -I../../ta/concurrent/include
CFLAGS += -I../../ta/concurrent_large/include
CFLAGS += -I../../ta/sha_perf/include
CFLAGS += -I../../ta/aes_perf/include
CFLAGS += -I../../ta/socket/include
CFLAGS += -I../../ta/sdp_basic/include

ifdef CFG_GP_PACKAGE_PATH
CFLAGS += -I../../ta/GP_TTA_Arithmetical
CFLAGS += -I../../ta/GP_TTA_Crypto
CFLAGS += -I../../ta/GP_TTA_DS
CFLAGS += -I../../ta/GP_TTA_TCF
CFLAGS += -I../../ta/GP_TTA_TCF_ICA
CFLAGS += -I../../ta/GP_TTA_TCF_ICA2
CFLAGS += -I../../ta/GP_TTA_TCF_MultipleInstanceTA
CFLAGS += -I../../ta/GP_TTA_TCF_SingleInstanceTA
CFLAGS += -I../../ta/GP_TTA_Time
CFLAGS += -I../../ta/GP_TTA_answerErrorTo_Invoke
CFLAGS += -I../../ta/GP_TTA_answerErrorTo_OpenSession
CFLAGS += -I../../ta/GP_TTA_answerSuccessTo_OpenSession_Invoke
CFLAGS += -I../../ta/GP_TTA_check_OpenSession_with_4_parameters
CFLAGS += -I../../ta/GP_TTA_testingClientAPI


# by default, the client application is compiled as the kernel of optee-os
ifeq ($(CFG_ARM32_core),y)
COMPILE_NS_USER ?= 32
else
COMPILE_NS_USER ?= 64
endif

endif

BINARY = attestation_storage

TA_DIR ?= /lib/optee_armtz
CFLAGS += -DTA_DIR=\"$(TA_DIR)\"

# Include configuration file generated by OP-TEE OS (CFG_* macros)
CFLAGS += -include conf.h

ifndef CFG_GP_PACKAGE_PATH
CFLAGS += -Wall -Wcast-align -Werror \
	  -Werror-implicit-function-declaration -Wextra -Wfloat-equal \
	  -Wformat-nonliteral -Wformat-security -Wformat=2 -Winit-self \
	  -Wmissing-declarations -Wmissing-format-attribute \
	  -Wmissing-include-dirs -Wmissing-noreturn \
	  -Wmissing-prototypes -Wnested-externs -Wpointer-arith \
	  -Wshadow -Wstrict-prototypes -Wswitch-default \
	  -Wwrite-strings \
	  -Wno-missing-field-initializers -Wno-format-zero-length
endif

CFLAGS += -g3

LDFLAGS += -L$(OPTEE_CLIENT_EXPORT)/lib -lteec
LDFLAGS += -lpthread -lm

.PHONY: all
all: attestation_storage

attestation_storage: $(OBJS)
	$(q)$(CC) -o $(out-dir)/xtest/$@ $+ $(LDFLAGS)

$(out-dir)/xtest/attestation_storage.o: attestation_storage.c
	$(q)mkdir -p $(out-dir)/xtest/
	@echo '  CC      $<'
	$(q)$(CC) $(CFLAGS) -c $< -o $@

.PHONY: clean
clean:
	$(q)rm -f $(out-dir)/xtest/attestation_storage
	$(q)$(foreach obj,$(objs), rm -f $(obj))
